#!/usr/bin/env bash
###############################################################################
#  auto_commit.sh ‚Äî PROD
#  ‚Ä¢ –ª–æ–≥: auto_commit.log (–≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ, —Å–≤–µ–∂–∏–µ –±–ª–æ–∫–∏ —Å–≤–µ—Ä—Ö—É, –Ω–µ –±–æ–ª–µ–µ 10)
#  ‚Ä¢ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ: auto_commit.sh, update_from_github.sh, Default.yaml
#  ‚Ä¢ commit-msg: ¬´add monolead¬ª / ¬´remove AdsPower Global¬ª
###############################################################################

set -euo pipefail
cd "$(dirname "$0")"

FILES=(auto_commit.sh update_from_github.sh Default.yaml)
LOG="auto_commit.log"
TMP_LOG="$(mktemp)"

##############################################################################
# –§—É–Ω–∫—Ü–∏—è prepend-–ª–æ–≥–∞ (—Å–≤–µ—Ä—Ö—É) + –æ–±—Ä–µ–∑–∫–∞ –¥–æ 10 –±–ª–æ–∫–æ–≤
goto_log() {
  { cat "$TMP_LOG"; [[ -f $LOG ]] && cat "$LOG"; } > "${LOG}.new"
  awk '
    BEGIN { cnt = 0 }
    /^==== .* START ====/ { cnt++ }
    cnt <= 10
  ' "${LOG}.new" > "$LOG"
  rm -f "$TMP_LOG" "${LOG}.new"
}

log() { echo "$@" | tee -a "$TMP_LOG"; }

log "==== $(date '+%F %T') START ===="

##############################################################################
# 0. —É–±–∏—Ä–∞–µ–º auto_commit.log –∏–∑ –∏–Ω–¥–µ–∫—Å–∞ (–µ—Å–ª–∏ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω)
git rm --cached --ignore-unmatch "$LOG" 2>/dev/null || true

##############################################################################
# 1. —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º—Å—è —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º
log "–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ GitHub..."
git fetch origin main

##############################################################################
# 2. –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –∫–æ–º–º–∏—Ç–∏–º –∏—Ö
if ! git diff --quiet || ! git diff --cached --quiet; then
  log "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Å–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –∫–æ–º–º–∏—Ç..."
  git add -A
  git commit -m "üõ† –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–≤—Ç–æ–∫–æ–º–º–∏—Ç –ø–µ—Ä–µ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π" | tee -a "$TMP_LOG"
fi

##############################################################################
# 3. –¥–µ–ª–∞–µ–º pull —Å merge (–∏–∑–±–µ–≥–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
log "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º..."
if ! git pull origin main --no-edit 2>&1 | tee -a "$TMP_LOG"; then
  log "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ pull - –≤–æ–∑–º–æ–∂–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã"
  log "==== $(date '+%F %T') ERROR END ===="
  goto_log
  exit 1
fi

##############################################################################
# 4. –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–∞–π–ª–∞—Ö –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
need_push=false
changed_files=()

for f in "${FILES[@]}"; do
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–º–º–∏—Ç–∞ –∏–ª–∏ –∏–Ω–¥–µ–∫—Å–∞
  if ! git diff --quiet HEAD -- "$f" 2>/dev/null || ! git diff --quiet --cached -- "$f" 2>/dev/null; then
    need_push=true
    changed_files+=("$f")
    log "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤: $f"
  fi
done

if [ "$need_push" = false ]; then
  log "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–∞–π–ª–∞—Ö ‚Äî –≤—ã—Ö–æ–¥"
  log "==== $(date '+%F %T') END ===="
  goto_log
  exit 0
fi

##############################################################################
# 5. –æ–ø—Ä–µ–¥–µ–ª—è–µ–º commit-msg –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Default.yaml
MSG="update configuration"

if [[ " ${changed_files[@]} " =~ " Default.yaml " ]]; then
  # –ò—â–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Default.yaml (—Ä–∞–±–æ—á–∞—è –∫–æ–ø–∏—è vs HEAD)
  diff_output=$(git diff HEAD -- Default.yaml 2>/dev/null || git diff --cached -- Default.yaml 2>/dev/null || echo "")
  
  if [[ -n "$diff_output" ]]; then
    # –ò—â–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
    added_line=$(echo "$diff_output" | grep -E '^\+\s*(DOMAIN-KEYWORD|PROCESS-NAME)' | head -n1 | sed 's/^\+//')
    # –ò—â–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã  
    removed_line=$(echo "$diff_output" | grep -E '^\-\s*(DOMAIN-KEYWORD|PROCESS-NAME)' | head -n1 | sed 's/^\-//')
    
    if [[ -n "$added_line" ]]; then
      service=$(echo "$added_line" | cut -d',' -f2 | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
      MSG="add $service"
      log "–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞: $service"
    elif [[ -n "$removed_line" ]]; then
      service=$(echo "$removed_line" | cut -d',' -f2 | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
      MSG="remove $service"
      log "–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —É–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞: $service"
    else
      MSG="update Default.yaml"
      log "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –¥—Ä—É–≥–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Default.yaml"
    fi
  fi
else
  # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö
  MSG="update scripts"
  log "–ò–∑–º–µ–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö"
fi

##############################################################################
# 6. —Å–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–º–∏—Ç –∏ –ø—É—à–∏–º (–µ—Å–ª–∏ –µ—Å—Ç—å —á—Ç–æ –∫–æ–º–º–∏—Ç–∏—Ç—å)
git add "${FILES[@]}"

if git diff --cached --quiet; then
  log "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤"
else
  log "–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞: $MSG"
  if git commit -m "$MSG" 2>&1 | tee -a "$TMP_LOG"; then
    log "‚úÖ –ö–æ–º–º–∏—Ç —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ"
  else
    log "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–º–∏—Ç–∞"
    log "==== $(date '+%F %T') ERROR END ===="
    goto_log
    exit 1
  fi
fi

##############################################################################
# 7. –ø—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
log "–û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ GitHub..."
if git push origin main 2>&1 | tee -a "$TMP_LOG"; then
  log "‚úÖ Push –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ ‚Äî $MSG"
else
  log "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ push"
  log "==== $(date '+%F %T') ERROR END ===="
  goto_log
  exit 1
fi

log "==== $(date '+%F %T') END ===="
goto_log